# システムアーキテクチャ

## 1. システムアーキテクチャ

本プロジェクトは、「推奨ブループリント」で結論付けられた技術スタックを採用します。

### 1.1 基盤フレームワーク: Tauri

**採用理由:**
- 圧倒的なパフォーマンス（高速起動、低メモリ消費）
- 「セキュア・バイ・デフォルト」のモデル
- Rustバックエンドを活用し、ファイルシステムのスキャンやタグ情報の解析といった重処理をフロントエンドからオフロード

**実装状況:** ✅ 完了
- Tauri 2.9.1を使用
- Windows, macOS, Linux対応

### 1.2 エディタコンポーネント: CodeMirror 6

**採用理由:**
- 優れたパフォーマンスとモジュール性
- 強力な拡張API
- タグ選択UIの統合や、リッチな編集体験の構築に最適

**実装状況:** ✅ 完了
- CodeMirror 6を使用
- Markdown構文ハイライト
- カスタム拡張機能（タグオートコンプリート）

### 1.3 パーシング（解析）アーキテクチャ: ハイブリッドRustバックエンド

#### タスク本文 (Markdown)
- **パーサー:** `comrak` 0.33 (Rust crate)
- **処理場所:** Rustバックエンド
- **目的:** 高速かつ安全に解析

**実装状況:** ✅ 完了

#### タグ情報 (Front Matter)
- **パーサー:** `serde_yaml` (Rust crate)
- **処理場所:** Rustバックエンド
- **目的:** 全タスクのメタデータを効率的に解析・集約

**実装状況:** ✅ 完了

#### ダイアグラム (Mermaid)
- **検出:** `comrak`がMermaidブロックを認識
- **レンダリング:** フロントエンドの `mermaid.js` 11.4
- **セキュリティ:** `securityLevel: 'antiscript'` + `maxTextSize: 50000`

**実装状況:** ✅ 完了

### 1.4 可視化・分析

#### ECharts
- **バージョン:** 5.5
- **用途:** ガントチャート、円グラフ、棒グラフ、折れ線グラフ
- **特徴:** インタラクティブなズーム・パン、高いカスタマイズ性

**実装状況:** ✅ 完了

#### Mermaid.js
- **バージョン:** 11.4
- **用途:** タスク本文内のダイアグラム描画
- **セキュリティ:** DOMPurify 3.2と組み合わせた3層防御

**実装状況:** ✅ 完了

### 1.5 フロントエンドスタック

- **React:** 18.3
- **TypeScript:** 5.7
- **Vite:** 6.4
- **状態管理:** React Hooks (useState, useEffect, useCallback, useMemo)
- **国際化:** i18next 24.2
- **フォント:** Inter (埋め込み)

**実装状況:** ✅ 完了

### 1.6 バックエンドスタック

- **Rust:** 1.90
- **主要クレート:**
  - `tauri` 2.9.1 - フレームワーク
  - `comrak` 0.33 - Markdownパーサー
  - `serde` / `serde_yaml` - YAML Front Matter解析
  - `notify` - ファイルウォッチャー
  - `chrono` - 日付・時刻処理

**実装状況:** ✅ 完了

### 1.7 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────┐
│                     Frontend (React)                     │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ TaskBrowser  │  │ TaskEditor   │  │  Analysis    │  │
│  │              │  │ (CodeMirror) │  │ (ECharts)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ TagManager   │  │TemplateManager│ │  Settings    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│              Tauri Commands (IPC Bridge)                │
├─────────────────────────────────────────────────────────┤
│                   Backend (Rust)                         │
├─────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Workspace    │  │ Tag Service  │  │ Template     │  │
│  │ Service      │  │              │  │ Service      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ File Watcher │  │ MD Parser    │  │ Analysis     │  │
│  │              │  │ (comrak)     │  │ Service      │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│                  File System (OS API)                    │
└─────────────────────────────────────────────────────────┘
```

### 1.8 データフロー

```
1. ユーザー操作
   ↓
2. React Component
   ↓
3. Tauri Command (invoke)
   ↓
4. Rust Service Layer
   ↓
5. File System / Parser
   ↓
6. Response → React State Update
   ↓
7. UI Re-render
```

### 1.9 セキュリティアーキテクチャ

**3層防御モデル:**

1. **markdown-it** - 初期Markdown→HTML変換
2. **DOMPurify** - XSSサニタイゼーション
3. **Mermaid Security** - `securityLevel: 'antiscript'`

**追加対策:**
- Tauri API最小化（必要なコマンドのみ公開）
- パストラバーサル防止（Tauri標準機能）
- ファイルパス検証（Rustバックエンド）

## 参照

- [機能要件](02-functional-requirements.md)
- [非機能要件](05-non-functional-requirements.md)
- [実装状況](../devlog/phase3-tag-system.md#313-tag-attribute-system-r-48-実装状況-進行中)
