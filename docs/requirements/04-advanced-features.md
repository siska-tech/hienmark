# 高度な機能

## 4. 高度な機能

### 4.1 タグ属性システム (Typed Tagging System) ⏳ 75% 実装完了

タスクのタグ（カテゴリ）に対して、`status`や`priority`といったキーごとに厳密なデータ型（属性）を定義できるようにする。これにより、データの一貫性を保証し、入力UIを最適化し、高度なフィルタリングと分析を可能にする。

### R-4.1.1 (タグ管理モードへの統合) ✅ 部分的実装

「R-2.3.6 (タグ管理モード)」を拡張し、ユーザーが新しいタグカテゴリを定義する際、必ず以下のいずれかの属性タイプを選択できるようにすること。

**実装状況:**
- ✅ TypeScript型定義完了
- ✅ Rustバックエンド完了
- ⏳ UI統合未完了

---

### R-4.1.2 (属性タイプの定義) ✅ バックエンド完了

以下の9つの属性タイプを実装すること。

| 属性タイプ | Front Matter保存形式 (例) | 説明 | 実装状況 |
|:---|:---|:---|:---:|
| **文字列 (String)** | `employeeId: "A-105"` | 汎用的なテキストデータ | ✅ |
| **数値 (Number)** | `progress: 75` | 計算対象となる数値（通貨以外） | ✅ |
| **はい/いいえ (Boolean)** | `completed: true` | `true` / `false` の二値 | ✅ |
| **日付と時刻 (Datetime)** | `dueDate: "2025-10-30T15:00:00"` | ISO 8601形式で保存される日付/時刻 | ✅ |
| **選択肢 (Select)** | `priority: "high"` | 定義済みリストから単一の値を選択 | ✅ |
| **複数選択肢 (MultiSelect)** | `tags: ["bug", "ui"]` | 定義済みリストから複数の値を選択（配列） | ✅ |
| **通貨 (Currency)** | `cost: 15000.00` | 高精度な財務計算用の数値 | ⏳ |
| **画像 (Image)** | `thumbnail: "./assets/img_01.png"` | ワークスペースからの相対パス | ⏳ |
| **ハイパーリンク (Hyperlink)** | `link: { url: "...", text: "..." }` | URLと説明テキストをオブジェクトとして保存 | ⏳ |

**実装済み:**
- TypeScript型定義（全9タイプ）
- Rustバックエンド（スキーマ管理、動的デフォルト値計算）
- 基本的な動的入力コンポーネント（Boolean, Select, MultiSelect, Number, Date）

**未実装:**
- Currency, Image, Hyperlink入力コンポーネント
- TagConfigEditorへの統合
- TagEditorPanelへの統合

---

### R-4.1.3 (属性ごとのカスタマイズオプション) ✅ バックエンド完了

タグ管理モードにおいて、属性タイプごとに以下のカスタマイズオプションを設定できること。

#### 文字列 (String)
- `maxLength` (文字数制限)
- `defaultValue` (既定値)

#### 数値 (Number)
- `min` (最小値), `max` (最大値)
- `decimalPlaces` (小数点以下の桁数)
- `defaultValue` (既定値)
- `formatAsPercentage` (パーセンテージとして表示)

#### はい/いいえ (Boolean)
- `defaultValue` (チェックの有無, `true`/`false`)

#### 日付と時刻 (Datetime)
- `format` (日付のみ / 日付と時刻)
- `defaultValue` (既定値。`static` (特定の値), `dynamic` (計算値, 例: `=[TODAY]+30`))

**実装状況:**
- ✅ Rustバックエンドで動的デフォルト値計算をサポート
  - `=[TODAY]` - 今日の日付
  - `=[TODAY]+7` - 7日後
  - `=[TODAY]-30` - 30日前

#### 選択肢 (Select / MultiSelect)
- `optionsList` (選択肢リストの定義)
- `allowManualEntry` (リスト外の値の手動入力を許可)
- `defaultValue` (既定値)
- `displayFormat` (ドロップダウン / ラジオボタン)
- `allowMultiple` (複数選択を許可するか。`true`ならMultiSelect, `false`ならSelect)

#### 通貨 (Currency)
- `min` (最小値), `max` (最大値)
- `decimalPlaces` (小数点以下の桁数)
- `defaultValue` (既定値)
- `currencyFormat` (通貨形式の選択, 例: JPY, USD)

#### 画像 (Image)
- (特になし。UI側でアップロード/置換/削除を実装)

#### ハイパーリンク (Hyperlink)
- (特になし。UI側でURLと説明テキストを入力)

---

### R-4.1.4 (入力UIの動的変更) ⏳ 部分的実装

GUIによるタグ編集時（`TagEditorPanel`）、タグの属性タイプに応じて入力コンポーネントを動的に変更すること。

| タイプ | 入力コンポーネント | 実装状況 |
|:---|:---|:---:|
| `String` | テキスト入力フィールド | ✅ |
| `Number` | 数値入力フィールド | ✅ |
| `Currency` | 数値入力フィールド（通貨記号付き） | ⏳ |
| `Boolean` | チェックボックス | ✅ |
| `Datetime` | 日付/時刻ピッカー | ✅ |
| `Select` | ドロップダウン または ラジオボタン | ✅ |
| `MultiSelect` | 複数選択ドロップダウン または チェックボックス群 | ✅ |
| `Image` | 画像アップロード/プレビュー/削除ボタン | ⏳ |
| `Hyperlink` | URLと説明テキストの入力フィールド | ⏳ |

**実装済みコンポーネント:**
- `BooleanInput.tsx`
- `SelectInput.tsx`
- `MultiSelectInput.tsx`
- `NumberInput.tsx`
- `DateInput.tsx`

**未実装コンポーネント:**
- `CurrencyInput.tsx`
- `ImageInput.tsx`
- `HyperlinkInput.tsx`

---

### R-4.1.5 (配列 (Array) 属性の除外) ✅ 設計決定

独立した「配列 (Array)」属性は実装しない。

**理由:**
- 「複数選択肢 (MultiSelect)」属性が、YAML形式の配列（例: `tags: [A, B, C]`）としてデータを保存する役割を担うため、機能が重複する。
- `MultiSelect`として定義することで、データ構造とUI機能を統一。

---

### R-4.1.6 (フィルター/ソート機能との連携) ✅ 実装済み

「R-2.2.5 (タスクフィルタ機能)」「R-2.2.4 (タスク並べ替え機能)」を本属性システムと連携させること。

**要件:**
- フィルター/ソート設定UIは、タグの属性タイプを認識すること。
- `Datetime`型には `>` `<` 演算子で日付比較（例: `dueDate >= [TODAY]`）を可能にする。
- `Number`/`Currency`型には `>` `<` 演算子で数値比較を可能にする。
- `Boolean`型は `true`/`false` での絞り込みを可能にする（また、集計時に `1`/`0` として扱う）。
- `Select`型はカスタム順序での並べ替えを可能にする。

**実装状況:** ✅ 実装済み
- フィルター評価器 (`filterEvaluator.ts`) でタグ属性タイプに応じた数値比較・正規表現等を実装
- カスタムフィルター機能で比較演算子（`==`, `!=`, `>`, `<`, `>=`, `<=`, `contains`, `starts_with`, `ends_with`, `regex`）をサポート
- カスタムソート機能でタグ設定の `tagType` に応じた数値型・日付型・文字列型のソートを実装
- `TaskBrowser.tsx` で `tagConfigs` を利用して属性タイプを参照

---

### 4.2 カンバンビュー ⏳ 未実装

#### REQ-KAN-001: カンバン機能の追加 ⏳ 未実装

**要件概要:**
タスクを視覚的に管理するため、タスクリスト、ガントチャートに並ぶ新しいビューとして「カンバンボード」を追加する。

**機能要件:**
- FR-3.1.1.1 (カラム定義): カラム（例：「未着手」「作業中」「レビュー」「完了」）をユーザーが自由に定義・保存できる
- FR-3.1.1.2 (カード表示): 各タスクを「カード」として表示する
- FR-3.1.1.3 (Drag & Drop): カードをカラム間でドラッグ＆ドロップすることで、タスクのステータスを変更できる

**受入基準:**
- AC-3.1.1.1: カンバンボード上でカードを「作業中」から「完了」に移動すると、REQ-ARC-001のSQLite DB内の該当タスクのステータスが更新される

**実装状況:** ⏳ 未実装（優先度: 中）

**依存関係:** REQ-ARC-001 (SQLite化) の完了後に実装可能

---

### 4.3 ガントチャート強化 ⏳ 未実装

#### REQ-GNT-001: インタラクティブ編集 ⏳ 未実装

**要件概要:**
既存のガントチャート・ビューのインタラクティブ性（対話的操作）を向上させる。

**機能要件:**
- FR-3.2.1.1 (日付編集): チャート上のタスクバーをドラッグして開始日・終了日を変更できる
- FR-3.2.1.2 (依存関係): チャート上でタスク間に依存関係（FS, SS, FF, SF）の線を引く、または削除できる

**受入基準:**
- AC-3.2.1.1: チャート上で日付を変更すると、タスクのメタデータ（due_date等）がリアルタイムで更新される

**実装状況:** ⏳ 未実装（優先度: 中）

---

#### REQ-GNT-002: カラム表示強化 ⏳ 未実装

**要件概要:**
ガントチャートの左側（タスク一覧部分）に、タスク名以外の追加情報を表示する。

**機能要件:**
- FR-3.2.2.1 (カラム追加): タスク名に加え、「担当者」「進捗率（%）」「優先度」などの関連情報を表形式で併記できる
- FR-3.2.2.2 (カラムカスタマイズ): 表示するカラムをユーザーが選択できる

**受入基準:**
- AC-3.2.2.1: ユーザーがガントチャート・ビュー上で、WBS（タスク名）とリソース（担当者）を同時に確認できる

**実装状況:** ⏳ 未実装（優先度: 中）

---

### 4.4 Gitワークフロー連携 ⏳ 未実装

HienMarkの中核思想である「Gitワークフロー連携」機能群。最重要機能として定義する。

#### REQ-GIT-001: ブランチスコープ機能（キラー機能） ⏳ 未実装

**要件概要:**
HienMarkが現在開いているプロジェクト（ワークスペース）のGitリポジトリ状態を自動認識し、アクティブなGitブランチに関連するタスクのみを表示（スコープ）する機能。

**機能要件:**
- FR-3.3.1.1 (ブランチ認識): HienMarkは、ローカルリポジトリの `.git/HEAD` ファイル（または `git symbolic-ref HEAD` コマンド）を監視し、現在チェックアウトされているブランチ名をリアルタイムで認識する
- FR-3.3.1.2 (タスク紐付け): タスク作成時または編集時に、そのタスクを特定のブランチ（または複数ブランチ）に関連付けるUIを提供する
- FR-3.3.1.3 (動的フィルタリング): 「ブランチスコープ」モードがONの場合、タスクリスト、カンバン、ガントチャートの全ビューは、カレントブランチ名が紐付けられたタスクのみを自動的にフィルタリングして表示する

**非機能要件:**
- NFR-3.3.1.1 (即時性): ユーザーが外部ターミナル等で `git checkout` を実行した場合、HienMarkは2秒以内にブランチ変更を検知し、ビューを自動リフレッシュすること

**受入基準:**
- AC-3.3.1.1: ターミナルで `git checkout feature/A` を実行すると、HienMarkのタスクリストが即座に「feature/Aに紐づくタスク」のみの表示に切り替わる
- AC-3.3.1.2: ターミナルで `git checkout main` を実行すると、タスクリストが「mainに紐づくタスク（または全タスク）」の表示に戻る

**実装状況:** ⏳ 未実装（優先度: 中、戦略的重要度: 最高）

---

#### REQ-GIT-002: Git連携UI（差分・履歴） ⏳ 未実装

**要件概要:**
タスクに関連するGitの変更履歴（log）および差分（diff）をHienMarkのUI上で確認できる。

**機能要件:**
- FR-3.3.2.1 (Log): 選択中のタスクの `git log` 実行結果をUI上に表示する
- FR-3.3.2.2 (Diff): 選択中のタスクの「現在の変更」（`git diff HEAD`）または「過去のコミットとの差分」を、サイド・バイ・サイド形式でUI上に表示する

**受入基準:**
- AC-3.3.2.1: ユーザーがタスクの変更履歴をHienMarkを離れることなく確認できる

**実装状況:** ⏳ 未実装（優先度: 中）

---

#### REQ-GIT-003: Git連携UI（コミット操作） ⏳ 未実装

**要件概要:**
HienMark UI上から `git add` および `git commit` を実行できる。

**機能要件:**
- FR-3.3.3.1 (Add): 変更されたタスクファイルを `git add`（ステージング）するUIボタンを実装する
- FR-3.3.3.2 (Commit): コミットメッセージ入力欄と「コミット」ボタンを実装し、`git commit -m "..."` を実行する

**非機能要件:**
- NFR-3.3.3.1 (認証): `git commit` を実行する際、OS環境に設定されているユーザーの `.gitconfig`（user.name, user.email）を尊重すること

**受入基準:**
- AC-3.3.3.1: HienMark上でタスクを編集し、「コミット」ボタンを押すと、`git log` で user.name が正しく設定されたコミットが生成されている

**実装状況:** ⏳ 未実装（優先度: 中）

---

#### REQ-GIT-004: Git連携UI（ブランチ操作） ⏳ 未実装

**要件概要:**
HienMark UI上からブランチの切り替え（checkout）ができる。

**機能要件:**
- FR-3.3.4.1 (UI): `git branch` で取得できるローカルブランチの一覧をドロップダウン等で表示し、選択したブランチに `git checkout` する機能を提供する

**受入基準:**
- AC-3.3.4.1: UIでブランチを切り替えると、REQ-GIT-001（ブランチスコープ機能）が即座に連動し、表示タスクが切り替わる

**実装状況:** ⏳ 未実装（優先度: 中）

---

## 実装状況サマリー

| タグ属性システム | 完成度 | 備考 |
|----------------|--------|------|
| R-4.1.1: タグ管理統合 | 50% | 型定義・バックエンド完了、UI未統合 |
| R-4.1.2: 属性タイプ定義 | 66% | 9タイプ中6タイプのUI実装完了 |
| R-4.1.3: カスタマイズオプション | 70% | バックエンド完了、UI未統合 |
| R-4.1.4: 入力UI動的変更 | 66% | 基本タイプ実装済み |
| R-4.1.5: 配列属性除外 | 100% | 設計決定済み |
| R-4.1.6: フィルタ/ソート連携 | 100% | 完全実装 |
| R-4.2: カンバンビュー | 0% | 未実装（優先度: 中） |
| R-4.3: ガントチャート強化 | 0% | 未実装（優先度: 中） |
| R-4.4: Gitワークフロー連携 | 0% | 未実装（戦略的最重要） |

**Phase 1-5 平均:** 75%
**全体平均（Phase 6含む）:** 50%

## 技術詳細

### データ保存形式

タグスキーマは `.hienmark/tag_schema.json` に保存：

```json
{
  "priority": {
    "type": "Select",
    "options": {
      "optionsList": ["very high", "high", "medium", "low", "very low"],
      "allowManualEntry": false,
      "defaultValue": "medium",
      "displayFormat": "dropdown"
    }
  },
  "dueDate": {
    "type": "Datetime",
    "options": {
      "format": "dateOnly",
      "defaultValue": {
        "type": "dynamic",
        "formula": "=[TODAY]+7"
      }
    }
  }
}
```

### Tauri Commands

実装済みコマンド：
- `load_tag_schema(workspace_path: String) -> Result<String, String>`
- `save_tag_schema(workspace_path: String, schema_json: String) -> Result<(), String>`
- `get_dynamic_default_value(formula: String) -> Result<String, String>`

## 参照

- [機能要件](02-functional-requirements.md)
- [実装状況](../devlog/phase3-tag-system.md#313-tag-attribute-system-r-48-実装状況-進行中)
- [データ管理要件](06-data-management.md)
