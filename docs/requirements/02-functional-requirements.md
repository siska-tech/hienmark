# 機能要件

## 2. 機能要件

### 2.1. コア機能：タスク編集 ✅ 実装完了

- **R-2.1.1 (Markdownレンダリング):** ✅ 実装済み
  - CommonMark仕様に準拠したMarkdownのリアルタイムプレビュー機能を提供すること。
  - 実装: markdown-it + DOMPurifyによる安全なHTML生成

- **R-2.1.2 (Mermaidレンダリング):** ✅ 実装済み
  - Markdown本文中に `` ```mermaid `` で記述されたMermaid記法を検出し、ダイアグラムとしてレンダリングできること。
  - 実装: mermaid.js 11.4 + セキュリティレベル設定

- **R-2.1.3 (シンタックスハイライト):** ✅ 実装済み
  - エディタ（CodeMirror 6）は、Markdown構文およびMermaidコードブロック内の構文をハイライトすること。
  - 実装: CodeMirror 6の言語パッケージを使用

---

### 2.2. タスク管理システム ✅ 100% 実装完了

- **R-2.2.1 (タスクの定義):** ✅ 実装済み
  - ワークスペース内の単一のMarkdownファイル（`.md`）を「1タスク」として扱うこと。

- **R-2.2.2 (タスクID):** ✅ 実装済み
  - 各タスクは一意のIDを持つこと。
  - プライマリIDはファイル名（OSの制約上、重複不可）とする。
  - タグ情報とファイル名を組み合わせた複合キーによる参照も可能とすること。

- **R-2.2.3 (タスクブラウザ):** ✅ 実装済み
  - ワークスペース内のタスク（ファイル）を一覧表示し、選択・オープン・削除ができるファイルブラウザ機能を有すること。

- **R-2.2.4 (タスク並べ替え機能):** ✅ 実装済み
  - タスク一覧を以下の基準で並べ替えられること：
    - タスク名（昇順/降順）
    - 最終更新日時（新しい順/古い順）
    - 作成日時（新しい順/古い順）
    - タグ値（例：ステータス、優先度）
  - 並べ替え基準はUI上で選択可能とすること。
  - 実装: `TaskBrowser.tsx` で標準ソート機能を実装、カスタムソート機能でタグ属性に応じた型別ソート（数値型、日付型、文字列型）を実装

- **R-2.2.5 (タスクフィルタ機能):** ✅ 実装済み
  - タスク一覧を以下の条件でフィルタリングできること：
    - 完了タスクの非表示
    - 遅延タスクの絞り込み（期限超過）
    - 最終更新日による絞り込み（日付範囲指定）
    - タグ条件による絞り込み（複数条件のAND/OR）
  - 複数のフィルタを組み合わせて適用できること。
  - 実装: `TaskBrowser.tsx` で標準フィルタ機能を実装、カスタムフィルタ機能で複合フィルター式（AND/OR/NOT、比較演算子、正規表現等）を実装

- **R-2.2.6 (タスクリネーム機能):** ✅ 実装済み（API完成、UI未統合）
  - タスクID（ファイル名）を変更できること。
  - リネーム時にファイルシステム上のファイル名も自動的に変更されること。
  - 他のタスクから参照されている場合（`depends_on`等）、参照も自動的に更新されること。
  - 実装: `renameTask` Tauri commandが存在、App.tsxに統合済み

---

### 2.3. タグ管理システム ✅ 100% 実装完了

- **R-2.3.1 (タグ情報の保存):** ✅ 実装済み
  - タスクの管理情報（タグ）は、各Markdownファイルの先頭に記述された「YAML Front Matter」ブロック内にキーと値のペアとして保存すること。

- **R-2.3.2 (タグの解析):** ✅ 実装済み
  - Rustバックエンドは、Tauriのファイルシステム機能を使用してワークスペース内の全タスクファイル（`.md`）をスキャンし、各ファイルのFront Matterを解析・集約すること。
  - 実装: `serde_yaml`を使用したFront Matter解析

- **R-2.3.3 (カテゴリ機能):** ✅ 実装済み
  - タグはカテゴリ（キー）と値（バリュー）の形式（例： `status: pending`）で管理すること。

- **R-2.3.4 (タグ選択UI):** ✅ 実装済み
  - エディタ（CodeMirror 6）には、Front Matterブロックの編集中に、既存のタグカテゴリと値をサジェストまたはドロップダウンから選択できるUIを統合すること。
  - 実装: CodeMirror 6カスタム拡張 `tagAutocomplete`

- **R-2.3.5 (タグリストの固定化):** ✅ 実装済み
  - アプリケーション設定により、タグの選択肢を「固定」または「任意追加可能」に切り替えられること。

- **R-2.3.6 (タグ管理モード):** ✅ 実装済み
  - 専用の「タグ管理モード」を設けること。
  - タグの「リネーム」、「編集」、「削除」のバッチ処理機能を提供すること。

- **R-2.3.7 (タグエイリアス機能):** ✅ 実装済み
  - タグカテゴリに対して、人間に優しい表示名（エイリアス）を設定できること。
  - 例：技術的なキー名`status`に対して日本語表示名`ステータス`を設定。

- **R-2.3.8 (タグ順序管理):** ✅ 実装済み
  - タスク編集画面において、タグの表示順序をドラッグ&ドロップで変更できること。
  - 変更された順序はFront Matterに反映されること。

- **R-2.3.9 (タグ値編集機能):** ✅ 実装済み
  - タグ編集パネルにおいて、タグの値を直接編集できること。
  - タグの属性タイプに応じた適切な入力UIを提供すること。

- **R-2.3.10 (タグ逆引き機能):** ✅ 実装済み
  - タグ管理画面において、特定のタグを使用しているタスクの一覧を表示できること。
  - 実装: `TagIndex` / `TagCategory` で `taskIds` にタスクIDを保持、`TagSettingsView.tsx` で値ごとのタスク表示機能を提供

- **R-2.3.11 (タグ管理の検索・フィルタ機能):** ✅ 実装済み
  - タグ管理画面において、タグを検索・フィルタリングできること。
  - 実装: `TagSettingsView.tsx` で検索、属性フィルタ、使用数フィルタ、テンプレートフィルタ、並べ替え機能を実装

---

### 2.4. タグテンプレート機能 ✅ 100% 実装完了

- **R-2.4.1 (テンプレートの登録):** ✅ 実装済み
  - ユーザーは、複数のタグ（カテゴリと値のペア）を組み合わせたタグセットを「テンプレート」として登録できること。

- **R-2.4.2 (テンプレートの編集):** ✅ 実装済み
  - 登録済みのテンプレートは、含まれるタグの追加・編集・削除ができること。

- **R-2.4.3 (テンプレートの適用):** ✅ 実装済み
  - タスク編集中に、既存のテンプレートを適用できること。
  - 新規タスク作成時にもテンプレートを選択できること。
  - **競合解決:** 上書きモード/マージモードを選択可能

- **R-2.4.7 (テンプレート連動型UI):** ✅ 実装済み
  - タスク編集画面において、タグの属性タイプ（R-4.1）に基づいた動的なUI要素を生成すること。

---

### 2.5. 分析モード ✅ 100% 実装完了

集約されたタグデータから、EChartsによる可視化を生成する機能を提供する。

- **R-2.5.1 (ガントチャート):** ✅ 実装済み
  - `start_date` / `end_date` / `depends_on` タグからタイムライン可視化を生成すること。
  - 実装: ECharts Gantt chart with dependency rendering

- **R-2.5.2 (円グラフ):** ✅ 実装済み
  - タグ値の分布を円グラフで表示すること。
  - 実装: ECharts Pie chart

- **R-2.5.3 (棒グラフ):** ✅ 実装済み
  - タグカテゴリの統計を棒グラフで表示すること。
  - 実装: ECharts Bar chart

- **R-2.5.4 (折れ線グラフ):** ✅ 実装済み
  - 時系列分析（例：完了トレンド）を折れ線グラフで表示すること。
  - 実装: ECharts Line chart

- **R-2.5.5 (エクスポート機能):** ✅ 実装済み
  - グラフをPNG/SVG形式でエクスポートできること。
  - 実装: `EChartsWrapper.tsx` で `exportChartAsImage` / `exportChartAsSVG` 関数を実装、PNG/SVGエクスポートボタンを提供

---

### 2.6. WYSIWYG編集機能 ⏳ 未実装

Markdownに不慣れなユーザーでも直感的にタスクを編集できるよう、リッチテキストエディタ（WYSIWYG）機能を追加する。

#### REQ-EDT-001: ビジュアルWYSIWYG編集 ⏳ 未実装

**要件概要:**
Markdownテキストビューに加え、リッチテキストエディタ（WYSIWYG）による編集が可能な「ビジュアルビュー」を実装する。

**機能要件:**
- FR-2.2.1.1: 太字、イタリック、打ち消し線、リスト（順序付き・順不同）、見出し（H1-H4）、引用、コードブロック、テーブルを操作する標準的なツールバーを実装する

**受入基準:**
- AC-2.2.1.1: Markdownに不慣れなユーザーが、ツールバー操作のみで標準的なMarkdownドキュメントを視覚的に作成・編集できる

**実装状況:** ⏳ 未実装（優先度: 高）

---

#### REQ-EDT-002: 双方向同期 ⏳ 未実装

**要件概要:**
「ビジュアルビュー」（WYSIWYG）と「Markdownソースビュー」間での、シームレスな双方向同期を実現する。

**機能要件:**
- FR-2.2.2.1 (Visual → MD): ビジュアルビューでの編集が即座にMarkdownソースビューに反映される
- FR-2.2.2.2 (MD → Visual): Markdownソースビューでの編集が即座にビジュアルビューにレンダリングされる

**非機能要件:**
- NFR-2.2.2.1 (同期遅延): ビュー間の同期遅延は100ms未満であること
- NFR-2.2.2.2 (堅牢性): 不正なMarkdownをソースビューに記述しても、ビジュアライザがクラッシュせず適切にハンドルすること

**受入基準:**
- AC-2.2.2.1: 両ビューを並べて表示し、片方で高速にタイピングした内容が、もう片方で遅延なく正確に反映され続ける

**実装状況:** ⏳ 未実装（優先度: 高）

---

#### REQ-EDT-003: テーブル編集機能 ⚠️ 一部実装

**要件概要:**
WYSIWYGビジュアルビュー内でテーブルの作成・編集を可能にし、かつ、生成されるMarkdownソースコードの可読性（アラインメント）を保証する。

**背景:**
Gitでの差分確認（git diff）において、テーブルのMarkdownソースが自動フォーマット（桁揃え）されていない場合、1セルのわずかな修正がテーブル全行の差分として検出され、変更レビューが著しく困難になる。本要件の最重要受入基準は、WYSIWYG操作性ではなく、生成されるMarkdownテキストが「可読性の高い（桁揃えされた）ソースコード」であることである。

**機能要件:**
- FR-2.2.3.1 (GUI操作): ビジュアルビューのツールバーから「テーブル挿入」（行・列を指定）、「行/列の追加・削除」の操作をGUIで行える ⏳ 未実装
- FR-2.2.3.2 (テキストアラインメント): セル内のテキストアラインメント（左、中央、右）をGUIで指定でき、Markdown ソースの `|:---|:---:|---:|` 形式に反映される ⏳ 未実装
- FR-2.2.3.3 (ソースコード・フォーマット): ビジュアルビューでテーブルを編集・保存した結果、生成されるMarkdownソースコードは、**技術要件 TR-001**（[09-technical-requirements.md](09-technical-requirements.md) 参照）に基づき、日本語（全角）と英数字（半角）が混在していても、視覚的に桁揃えされた状態でフォーマットされること ✅ **実装完了（Markdownエディタ統合）**

**受入基準:**
- AC-2.2.3.1: ビジュアルビューでテーブルの行・列を追加・編集できる ⏳ 未実装
- AC-2.2.3.2 (重要): 日本語と英数字が混在するテーブルをビジュアルビューで作成・編集した際、対応するMarkdownソースがTR-001の定義に基づき、完璧にアラインメントされる ✅ **達成（MarkdownエディタでTR-001フォーマッタを使用）**

**実装状況:** ⚠️ **一部実装**（優先度: 高）
- ✅ **TR-001フォーマッタ実装完了**: テーブルフォーマット機能を実装・検証完了
- ✅ **CodeMirror統合**: キーボードショートカット（`Ctrl+Shift+T`）と右クリックメニューで使用可能
- ⏳ **WYSIWYG統合**: WYSIWYGエディタでのテーブルGUI操作は未実装

**技術参照:** [TR-001 Markdownテーブルの文字幅計算とアラインメント](09-technical-requirements.md#tr-001) ✅ **実装完了**

---

#### REQ-EDT-004: アセット管理 ⏳ 未実装

**要件概要:**
タスクに（ローカルの）画像やファイルを埋め込む際、対象ファイルをワークスペース（プロジェクトフォルダ）内に自動的にコピーし、リンクを相対パスで管理する。

**機能要件:**
- FR-2.2.4.1 (ファイルコピー): 外部パス（例：`/User/Desktop/image.png`）からファイルをドラッグ＆ドロップした場合、ファイルをワークスペース内の所定のフォルダ（例：`.hienmark/assets/`）に一意な名前でコピーする
- FR-2.2.4.2 (相対パス挿入): コピー後、Markdownソースには（例：`![image.png](./.hienmark/assets/image.png)`）のように、相対パスでリンクを自動挿入する

**受入基準:**
- AC-2.2.4.1: タスクに画像を添付した後、プロジェクトフォルダ全体を別のPCやディレクトリに移動（またはgit clone）しても、画像リンクが切れずに表示される

**実装状況:** ⏳ 未実装（優先度: 高）

---

## 実装状況サマリー

| 機能カテゴリ | 完成度 | 備考 |
|------------|--------|------|
| R-2.1: タスク編集 | 100% | 完全実装 |
| R-2.2: タスク管理 | 100% | 完全実装 |
| R-2.3: タグ管理 | 100% | 完全実装 |
| R-2.4: タグテンプレート | 100% | 完全実装 |
| R-2.5: 分析モード | 100% | 完全実装 |
| R-2.6: WYSIWYG編集 | 0% | 未実装（優先度: 高） |

**Phase 1-5 平均:** 100%
**全体平均（Phase 6含む）:** 83%

## 参照

- [システムアーキテクチャ](01-architecture.md)
- [UI/UX要件](03-ui-ux-requirements.md)
- [高度な機能](04-advanced-features.md)
