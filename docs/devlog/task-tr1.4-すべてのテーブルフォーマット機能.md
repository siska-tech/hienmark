---
status: completed
priority: medium
assignee: FE
start_date: 2025-01-30
end_date: 2025-01-30
tags: ["技術要件", "TR-001", "実装", "React", "テーブルフォーマッタ", "機能拡張"]
depends_on: ["Task-TR1.2"]
---

# Task-TR1.4: すべてのテーブルフォーマット機能

## 概要

テーブルフォーマッタ機能を拡張し、ドキュメント内のすべてのテーブルを一度にフォーマットできる機能を追加する。

## 背景

既存のテーブルフォーマッタ（Task-TR1.2）は、カーソル位置のテーブルのみをフォーマットする機能でしたが、複数のテーブルを含むドキュメントでは、各テーブルを個別にフォーマットする必要がありました。これを改善するため、「すべてのテーブルをフォーマット」機能を追加しました。

## タスク詳細

### 実装要件

- **機能:** ドキュメント内のすべてのテーブルを検出し、一括でフォーマット
- **UI:** コンテキストメニューに「すべてのテーブルをフォーマット (Format All Tables)」オプションを追加
- **キーボードショートカット:** `Ctrl+Shift+Alt+T` (Mac: `Cmd+Shift+Alt+T`)

### 実装方針

- 既存の`formatTable()`関数を再利用
- ドキュメント全体をスキャンしてすべてのテーブル範囲を検出
- 後ろから順に処理（前方から処理すると範囲がずれるため）
- 変更がない場合は何もしない

### チェックリスト

- [x] `findAllTables()`関数の実装（すべてのテーブル範囲を検出）
- [x] `formatAllTablesCommand()`コマンドの実装
- [x] コンテキストメニューへの追加
- [x] キーボードショートカットの追加
- [x] テスト（リンターエラーなし）

## 実装内容

### 追加された機能

### 1. `findAllTables()`関数

ドキュメント内のすべてのテーブル範囲を見つける関数を追加。

```typescript
function findAllTables(doc: EditorState['doc']): Array<{ from: number; to: number }>
```

**特徴:**
- 重複検出を防ぐため、処理済み行を管理
- テーブル行とセパレーター行のパターンマッチング
- テーブルが少なくとも2行あることを確認

### 2. `formatAllTablesCommand()`コマンド

すべてのテーブルを一括フォーマットするCodeMirrorコマンド。

**処理フロー:**
1. ドキュメント内のすべてのテーブル範囲を検出
2. テーブルが見つからない場合は何もしない
3. テーブルを後ろから順に処理（範囲のずれを防止）
4. 各テーブルを`formatTable()`でフォーマット
5. 変更があった場合のみ、一括で適用

### 3. コンテキストメニューの拡張

右クリックメニューに2つのオプションを表示：

- **「テーブルをフォーマット (Format Table)」**
  - カーソル位置のテーブルのみをフォーマット
  - カーソル位置にテーブルがある場合のみ表示

- **「すべてのテーブルをフォーマット (Format All Tables)」**
  - ドキュメント内のすべてのテーブルをフォーマット
  - ドキュメント内にテーブルがある場合、常に表示

### 4. キーボードショートカット

- `Ctrl+Shift+T` (Mac: `Cmd+Shift+T`): カーソル位置のテーブルをフォーマット（既存）
- `Ctrl+Shift+Alt+T` (Mac: `Cmd+Shift+Alt+T`): すべてのテーブルをフォーマット（新規追加）

## 実装ファイル

- `src/editor/extensions/tableFormatter.ts`
  - `findAllTables()`関数（145-227行目）
  - `formatAllTablesCommand()`コマンド（239-277行目）
  - コンテキストメニューの拡張（327-353行目、355-383行目）
  - キーボードショートカット追加（456-459行目）

## 使用方法

### キーボードショートカット

- Windows/Linux: `Ctrl+Shift+Alt+T`
- Mac: `Cmd+Shift+Alt+T`

### 右クリックメニュー

1. エディタ内を右クリック
2. 「すべてのテーブルをフォーマット (Format All Tables)」を選択

## 動作確認

- ✅ リンターエラー: なし
- ✅ TypeScriptコンパイル: エラーなし（テーブルフォーマッタ関連）
- ✅ 実装完了

## 技術的詳細

### テーブル検出アルゴリズム

1. ドキュメント全体をスキャン
2. テーブル行（`|`で始まり`|`で終わる行）またはセパレーター行を検出
3. 各テーブルの開始行と終了行を特定（空行で区切られる）
4. 重複を防ぐため、処理済み行を記録

### フォーマット処理の最適化

- **後ろから順に処理**: 前方から処理すると、後続のテーブルの範囲がずれるため、後ろから処理することで範囲のずれを防止
- **一括適用**: すべての変更を1回の`dispatch()`で適用し、パフォーマンスを向上

## 関連タスク

- **Task-TR1.2**: テーブルフォーマッタ実装（ベース機能・依存タスク）
- **Task-TR1.3**: TR-001検証
- **BUG-EDT-1.3**: テーブルフォーマッタテーブル消失バグ（修正済み）

## メモ

- 既存の`formatTable()`関数をそのまま再利用
- TR-001仕様に準拠したフォーマットを維持
- カーソル位置はフォーマット後も維持される

## 完了記録

**完了日:** 2025-01-30

**成果物:**
- すべてのテーブルをフォーマットする機能の実装
- コンテキストメニューとキーボードショートカットの追加

**テスト結果:**
- リンターエラー: なし
- TypeScriptコンパイル: 成功（既存の別エラーは無関係）

