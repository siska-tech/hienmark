---
status: completed
priority: high
assignee: FE
start_date: 2025-01-30
end_date: 2025-01-30
tags: ["バグ修正", "エディタ", "ビジュアルビュー", "リンク", "Tauri"]
depends_on: []
---

# BUG-EDT-1.1: ビジュアルビューでリンクをクリックするとHienMarkが再起動する

## 概要

ビジュアルビュー（プレビューパネル）でマークダウンリンクをクリックすると、アプリケーションが再起動してしまう問題が発生していました。

## バグ詳細

### 症状

- ビジュアルビューでテーブル内のリンク（例: `[詳細](./task-arc-1.5-差分更新ロジック実装.md)`）をクリック
- 完全なURLリンク（例: `http://localhost:5173/requirements/10-implementation-roadmap.md`）をクリック
- アプリケーションが再起動してしまう

### 原因

1. Tauriアプリ内で外部URLへの遷移が発生し、アプリの再起動を引き起こしていた
2. リンククリックのイベントハンドラが、存在しないタスクや`.md`でないリンクに対してデフォルトのブラウザ動作を許可していた
3. 相対パス（`../requirements/10-implementation-roadmap.md`）の処理が不完全だった

### 影響範囲

- ビジュアルビューのプレビューパネル
- マークダウンテーブル内のリンク
- 相対パスを含むリンク
- URLエンコードされたリンク

## 修正内容

### 修正ファイル

- `src/components/TaskEditor/TaskEditor.tsx`

### 修正内容

1. **すべてのリンククリックをインターセプト**
   - Tauriアプリ内ではすべてのリンククリックで `e.preventDefault()` と `e.stopPropagation()` を呼び出し、デフォルト動作を防止

2. **相対パスの処理改善**
   - `../requirements/10-implementation-roadmap.md` のような相対パスから、パスを分割して最後の部分（ファイル名）を抽出

3. **完全なURLパスの処理改善**
   - `http://localhost:5173/requirements/10-implementation-roadmap.md` のような完全なURLからも、パスの最後の部分を正しく抽出

4. **URLエンコードのデコード処理**
   - エンコードされた文字（`%E5%8...` など）を正しくデコード

5. **デバッグログの追加**
   - リンク処理の状況を確認するため、コンソールログを追加

### 修正後の動作

- 存在するタスクへの`.md`リンク: アプリ内でタスクが開かれる
- 存在しないタスクへのリンク: 何も実行されず、アプリの再起動も発生しない
- `.md`でない外部リンク: 何も実行されず、アプリの再起動も発生しない
- 相対パスのリンク: 正しくファイル名を抽出し、タスクが存在すれば開く

## テスト項目

- [x] 相対パスリンク（`./task-xxx.md`）のクリック
- [x] 完全なURLリンク（`http://localhost:5173/task-xxx.md`）のクリック
- [x] URLエンコードされたリンクのクリック
- [x] 存在しないタスクへのリンクのクリック
- [x] 外部URLへのリンクのクリック
- [x] アプリが再起動しないことを確認

## 関連ファイル

- `src/components/TaskEditor/TaskEditor.tsx` (409-494行目)

## メモ

- Tauriアプリ内では外部URLへの遷移を防ぐことが重要
- すべてのリンククリックをインターセプトすることで、アプリの再起動を防止

